# Day 7: Orchestration (3-Stage Pipeline)

> **GitHub Repository**: [RAG-on-Local-CPU-minimal](https://github.com/rechard0609/RAG-on-Local-CPU-minimal)

> RAG íŒŒì´í”„ë¼ì¸ ê³ ë„í™” - ì œì–´ ê°€ëŠ¥í•œ êµ¬ì¡°

---

## ğŸ¯ í•™ìŠµ ëª©í‘œ

Day 7ì˜ í•µì‹¬ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

> **"RAGë¥¼ 3ë‹¨ê³„ë¡œ ë¶„ë¦¬í•˜ê³ , ê° ë‹¨ê³„ë¥¼ ì¶”ì  ê°€ëŠ¥í•˜ê²Œ ë§Œë“ ë‹¤"**

ì´ Dayë¥¼ ë§ˆì¹˜ë©´:
- âœ… Orchestration íŒ¨í„´ ì´í•´
- âœ… 3-Stage Pipeline êµ¬ì¡°
- âœ… Trace ê°ì²´ë¡œ ì¶”ì 
- âœ… ë‹¨ê³„ë³„ ì±…ì„ ë¶„ë¦¬

**í•µì‹¬:** Retrieve â†’ Rerank â†’ Generate

---

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
Rag_minimal_day7/
â”œâ”€ main.py            # FastAPI ì§„ì…ì 
â”œâ”€ pipeline.py        # íŒŒì´í”„ë¼ì¸ ì§„ì…
â”œâ”€ orchestration.py   # ì œì–´ íƒ€ì›Œ â† í•µì‹¬
â”œâ”€ models.py          # Trace ê°ì²´ â† ì‹ ê·œ
â”œâ”€ embedding.py       # ì„ë² ë”©
â”œâ”€ vectorstore.py     # Vector ê²€ìƒ‰
â”œâ”€ keyword_index.py   # Keyword ê²€ìƒ‰ â† ì‹ ê·œ
â”œâ”€ reranker.py        # Score Fusion
â”œâ”€ ingest.py          # ìì‚° ìƒì„±
â”œâ”€ loader.py          # ë¬¸ì„œ ë¡œë”©
â”œâ”€ llm.py             # LLM Stub
â”œâ”€ config.py          # ì„¤ì •
â””â”€ data/
   â””â”€ docs.txt        # ì…ë ¥ ë¬¸ì„œ
```

---

## ğŸ”„ ì‹¤í–‰ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /chat   â”‚  {"query": "..."}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   main.py    â”‚  API ì§„ì…ì 
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pipeline.py  â”‚  íŒŒì´í”„ë¼ì¸ í˜¸ì¶œ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orchestration.py        â”‚  ì œì–´ íƒ€ì›Œ
â”‚  run_pipeline()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚          â”‚
    â–¼               â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1 â”‚    â”‚ STEP 2  â”‚  â”‚ STEP 3  â”‚
â”‚Retrieveâ”‚ â†’  â”‚ Rerank  â”‚â†’ â”‚Generate â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚          â”‚
    â–¼               â–¼          â–¼
 10ê°œ í›„ë³´       3ê°œ ì„ íƒ    ìµœì¢… ë‹µë³€
    â”‚               â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚PipelineTrace â”‚  ì „ì²´ ì¶”ì 
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ ì„¤ì¹˜ ë° ì‹¤í–‰

### 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
cd Rag_minimal_day7
pip install fastapi uvicorn sentence-transformers faiss-cpu rank-bm25
```

### 2. ì„œë²„ ì‹¤í–‰

```bash
uvicorn main:app --reload
```

### 3. API í…ŒìŠ¤íŠ¸

**curl (PowerShell):**
```powershell
curl -X POST "http://127.0.0.1:8000/chat" `
  -H "Content-Type: application/json" `
  -d '{"query":"RAGë€ ë¬´ì—‡ì¸ê°€?"}'
```

---

## ğŸ§  í•µì‹¬ ê°œë…

### 1. Orchestration íŒ¨í„´

**ì œì–´ íƒ€ì›Œ:**
```python
def run_pipeline(query):
    # 1ë‹¨ê³„: Retrieve
    retrieve_result = step_retrieve(query)
    
    # 2ë‹¨ê³„: Rerank
    rerank_result = step_rerank(query, retrieve_result)
    
    # 3ë‹¨ê³„: Generate
    generate_result = step_generate(query, rerank_result)
    
    # ì „ì²´ ì¶”ì 
    return PipelineTrace(
        retrieve=retrieve_result,
        rerank=rerank_result,
        generate=generate_result
    )
```

### 2. 3-Stage Pipeline

**STEP 1: Retrieve (ê²€ìƒ‰)**
- Vector Search
- Keyword Search
- í›„ë³´ ë³‘í•©
- ê²°ê³¼: 10ê°œ í›„ë³´

**STEP 2: Rerank (ì¬ì •ë ¬)**
- Score Fusion
- Top-N ì„ íƒ
- ê²°ê³¼: 3ê°œ ì»¨í…ìŠ¤íŠ¸

**STEP 3: Generate (ìƒì„±)**
- í”„ë¡¬í”„íŠ¸ êµ¬ì„±
- LLM í˜¸ì¶œ
- ê²°ê³¼: ìµœì¢… ë‹µë³€

### 3. Trace ê°ì²´

**ê´€ì¸¡ ê°€ëŠ¥:**
```python
@dataclass
class PipelineTrace:
    query: str
    retrieve: RetrieveResult    # 10ê°œ
    rerank: RerankResult        # 3ê°œ
    generate: GenerateResult    # ë‹µë³€
```

**í™œìš©:**
- ë””ë²„ê¹…
- í’ˆì§ˆ ê²€ì¦
- A/B í…ŒìŠ¤íŠ¸

---

## âœ… Day 7 ì™„ë£Œ ê¸°ì¤€

ë‹¤ìŒì„ ì´í•´í•˜ê³  ì‹¤ìŠµí–ˆë‹¤ë©´ ì™„ë£Œì…ë‹ˆë‹¤:

### ì´í•´
- âœ”ï¸ Orchestration ì—­í• 
- âœ”ï¸ 3ë‹¨ê³„ ë¶„ë¦¬ ì´ìœ 
- âœ”ï¸ Trace ê°ì²´ í™œìš©
- âœ”ï¸ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

### ì‹¤ìŠµ
- âœ”ï¸ ì„œë²„ ì‹¤í–‰ ì„±ê³µ
- âœ”ï¸ `/chat` API í˜¸ì¶œ
- âœ”ï¸ Trace ê²°ê³¼ í™•ì¸
- âœ”ï¸ ë‹¨ê³„ë³„ ì¶œë ¥ í™•ì¸

---

## ğŸ”œ ë‹¤ìŒ ë‹¨ê³„ (Day 8)

Day 8ì—ì„œëŠ”:
- âœ… LLM Gateway íŒ¨í„´
- âœ… ì™¸ë¶€ LLM API ì—°ê²°
- âœ… ë¡œì»¬ LLM í†µí•©
- âœ… API Key ê´€ë¦¬

ì‹¤ì œ LLM ì—°ê²°!

---

## ğŸ“œ ë¼ì´ì„ ìŠ¤

Copyright Â© 2022 ì •ìƒí˜ (Sanghyuk Jung)

ë³¸ ì €ì‘ë¬¼ì€ [í¬ë¦¬ì—ì´í‹°ë¸Œ ì»¤ë¨¼ì¦ˆ ì €ì‘ìí‘œì‹œ-ë¹„ì˜ë¦¬-ë³€ê²½ê¸ˆì§€ 4.0 êµ­ì œ ë¼ì´ì„ ìŠ¤](https://creativecommons.org/licenses/by-nc-nd/4.0/)ì— ë”°ë¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í—ˆìš©
- âœ… ê°œì¸ í•™ìŠµ ëª©ì  ì‚¬ìš©
- âœ… ì¶œì²˜ í‘œì‹œ í›„ ë¹„ì˜ë¦¬ ê³µìœ 

### ê¸ˆì§€
- âŒ ìƒì—…ì  ì´ìš©
- âŒ ë‚´ìš© ìˆ˜ì • ë° 2ì°¨ ì €ì‘
- âŒ ì €ì‘ì í—ˆë½ ì—†ëŠ” ì¬ë°°í¬

**ìƒì—…ì  ì´ìš© ë¬¸ì˜**: j4angguiop@gmail.com

---

**â­ ì´ í”„ë¡œì íŠ¸ê°€ ë„ì›€ì´ ë˜ì—ˆë‹¤ë©´ Starë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!**

**Copyright Â© 2022-2026 ì •ìƒí˜ (Sanghyuk Jung). All Rights Reserved.**